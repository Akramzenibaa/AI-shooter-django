{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="page page-no-padding-top">
    <header class="topbar" id="navbar">
        <div class="topbar-content">
            <a href="{% url 'core:landing' %}" class="logo {% if user.is_authenticated %}logo-auth{% endif %}">
                <img src="{% static 'assets/logo.png' %}" alt="Logo">
                <span>AI Shooter</span>
            </a>

            <div class="topbar-actions" id="auth-section">
                {% if not user.is_authenticated %}
                <div id="google-btn"></div>
                <div class="flex-gap-small desktop-only">
                    <a href="{% url 'account_login' %}?next={{ request.path }}" class="btn small secondary">Login</a>
                    <a href="{% url 'account_signup' %}?next={{ request.path }}" class="btn small">Register</a>
                </div>
                {% else %}
                <div class="credits desktop-only">
                    <span class="credit-count"><span id="credit-value">{{ user.userprofile.credits|default:0 }}</span>
                        Credits</span>
                    <span class="plan-badge-ui">{{ user.userprofile.get_plan_type_display }}</span>
                    <a href="{% url 'core:pricing' %}" class="getmore no-decoration" id="getmore-btn">âœ¨ Get More</a>
                </div>
                <div class="user desktop-only">
                    <img src="{{ user.socialaccount_set.all.0.get_avatar_url|default:'https://www.gravatar.com/avatar/' }}"
                        alt="{{ user.email }}">
                    <span class="desktop-only">{{ user.first_name|default:user.email }}</span>
                    <form action="{% url 'account_logout' %}" method="post" class="form-inline">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.path }}">
                        <button type="submit" class="btn small secondary btn-small-padding">Sign
                            out</button>
                    </form>
                </div>
                {% endif %}
            </div>

            <button class="hamburger-btn mobile-only" id="hamburger-menu" aria-label="Menu">
                <i data-lucide="menu"></i>
            </button>
        </div>
    </header>

    <!-- Mobile Drawer -->
    <div class="drawer-overlay" id="drawer-overlay"></div>
    <div class="mobile-drawer" id="mobile-drawer">
        <div class="drawer-header">
            <div class="logo">
                <img src="{% static 'assets/logo.png' %}" alt="Logo">
                <span>AI Shooter</span>
            </div>
            <button class="close-drawer" id="close-drawer">
                <i data-lucide="x"></i>
            </button>
        </div>
        <div class="drawer-content">
            {% if user.is_authenticated %}
            <div class="drawer-user-info">
                <img src="{{ user.socialaccount_set.all.0.get_avatar_url|default:'https://www.gravatar.com/avatar/' }}"
                    alt="{{ user.email }}" class="drawer-avatar">
                <div class="drawer-user-details">
                    <span class="drawer-username">{{ user.first_name|default:user.email }}</span>
                    <span class="plan-badge-ui">{{ user.userprofile.get_plan_type_display }}</span>
                </div>
            </div>
            <div class="drawer-stats">
                <div class="drawer-stat-item">
                    <span class="stat-label">Credits</span>
                    <span class="stat-value">{{ user.userprofile.credits|default:0 }}</span>
                </div>
                <a href="{% url 'core:pricing' %}" class="getmore-drawer no-decoration">âœ¨ Get More Credits</a>
            </div>
            <div class="drawer-links">
                <a href="{% url 'core:history' %}" class="drawer-link">
                    <i data-lucide="image"></i> History
                </a>
                <a href="{% url 'core:landing' %}" class="drawer-link">
                    <i data-lucide="home"></i> Home
                </a>
                <form action="{% url 'account_logout' %}" method="post" class="drawer-logout-form">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.path }}">
                    <button type="submit" class="drawer-link logout-btn">
                        <i data-lucide="log-out"></i> Sign Out
                    </button>
                </form>
            </div>
            {% else %}
            <div class="drawer-links">
                <a href="{% url 'account_login' %}?next={{ request.path }}" class="drawer-link">Login</a>
                <a href="{% url 'account_signup' %}?next={{ request.path }}" class="drawer-link highlight">Register</a>
            </div>
            {% endif %}
        </div>
    </div>

    <main class="content">
        <div class="main-area">
            <section class="hero">
                <h1>AI Photo Shooter</h1>
                <p>Upload an image of your product and get enhanced photos</p>
                {% if not user.is_authenticated %}
                <div class="login-warning">
                    <i data-lucide="info"></i>
                    <span>Please log in to start creating magic</span>
                </div>
                {% else %}
                <div class="user-status-dashboard">
                    <div class="status-badge credits-badge">
                        <i data-lucide="zap"></i>
                        <span>{{ user.userprofile.credits|default:0 }} Credits</span>
                    </div>
                    <div class="status-badge plan-badge">
                        <i data-lucide="shield-check"></i>
                        <span>{{ user.userprofile.get_plan_type_display }} Plan</span>
                    </div>
                </div>
                {% endif %}
            </section>

            <section class="card uploader">
                <div class="dropzone" id="dropzone" role="button" tabIndex="0">
                    <div id="dropzone-content">
                        <div class="cloud"><i data-lucide="upload-cloud"></i></div>
                        <div class="hint">Click to select an image</div>
                    </div>
                    <img id="preview-img" class="dz-preview hidden" src="" alt="Selected image">
                </div>
                <input id="image-input" type="file" accept="image/*" class="hidden">

                <div class="count">
                    <div class="label">Generation Mode:</div>
                    <div class="opts mode-opts">
                        <button class="opt mode-opt selected" data-mode="creative">âœ¨ Campaign</button>
                        <button class="opt mode-opt" data-mode="model">ðŸ‘¤ On Model</button>
                        <button class="opt mode-opt" data-mode="background">â¬œ Clean BG</button>
                    </div>
                </div>

                <div class="count">
                    <div class="label" for="user-prompt">Additional Instructions (Optional):</div>
                    <textarea id="user-prompt" class="text-input"
                        placeholder="e.g. Make it dark & moody, add blue lighting..."></textarea>
                </div>

                <div class="count">
                    <div class="label">Images to generate:</div>
                    <div class="opts count-opts">
                        {% for n in "1234"|make_list %}
                        <button class="opt count-opt {% if forloop.counter == 4 %}selected{% endif %}"
                            data-count="{{ forloop.counter }}">{{ forloop.counter }}</button>
                        {% endfor %}
                    </div>
                    <div class="deduct-msg" id="deduct-msg">Cost: 4 credits</div>
                </div>

                <button class="generate-btn" id="generate-btn"
                    data-authenticated="{{ user.is_authenticated|yesno:'true,false' }}"
                    data-login-url="{% url 'account_login' %}?next={{ request.path }}">Generate</button>
                <div class="error-msg hidden" id="error-msg"></div>
                <div class="status" id="status-msg"></div>
            </section>

            <section class="card generating hidden" id="generating-card">
                <div class="spinner"></div>
                <div class="gen-title">Your photos are being generated...</div>
            </section>

            <section class="card results hidden" id="results-card">
                <div class="results-header">
                    <h3>Generated Images</h3>
                </div>
                <div class="gallery" id="results-gallery"></div>
            </section>
        </div>

        <aside class="history-sidebar">
            <div class="history-header">
                <div class="history-title">History</div>
                {% if history %}
                <a href="{% url 'core:history' %}" class="history-view-all">View All</a>
                {% endif %}
            </div>
            <div class="history-grid" id="history-grid">
                <!-- Server rendered history -->
                {% for img in history %}
                <div class="history-item">
                    <img src="{{ img.thumbnail_url|default:img.image_url }}" alt="History" loading="lazy">
                    <a href="{{ img.high_res_url|default:img.image_url }}" download class="dl-icon" title="Download">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-6 h-6">
                            <path fillRule="evenodd"
                                d="M12 2.25a.75.75 0 01.75.75v11.69l3.22-3.22a.75.75 0 111.06 1.06l-4.5 4.5a.75.75 0 01-1.06 0l-4.5-4.5a.75.75 0 111.06-1.06l3.22 3.22V3a.75.75 0 01.75-.75zm-9 13.5a.75.75 0 01.75.75v2.25a1.5 1.5 0 001.5 1.5h13.5a1.5 1.5 0 001.5-1.5v-2.25a.75.75 0 011.5 0v2.25a3 3 0 01-3 3H4.5a3 3 0 01-3-3v-2.25a.75.75 0 01.75-.75z"
                                clipRule="evenodd" />
                        </svg>
                    </a>
                </div>
                {% empty %}
                <div class="history-empty">No history yet</div>
                {% endfor %}
            </div>
        </aside>
    </main>

    <div class="modal hidden" id="image-modal">
        <img id="modal-img" src="" alt="Full view">
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Navbar scroll effect
    const navbar = document.getElementById('navbar');
    window.addEventListener('scroll', () => {
        if (window.scrollY > 50) {
            navbar.classList.add('scrolled');
        } else {
            navbar.classList.remove('scrolled');
        }
    });

    // Initialize Lucide icons
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    } else {
        window.addEventListener('load', () => lucide.createIcons());
    }

    // Mobile Drawer Logic
    const hamburgerBtn = document.getElementById('hamburger-menu');
    const closeDrawerBtn = document.getElementById('close-drawer');
    const mobileDrawer = document.getElementById('mobile-drawer');
    const drawerOverlay = document.getElementById('drawer-overlay');

    function toggleDrawer() {
        mobileDrawer.classList.toggle('active');
        drawerOverlay.classList.toggle('active');
        document.body.style.overflow = mobileDrawer.classList.contains('active') ? 'hidden' : '';
    }

    if (hamburgerBtn) hamburgerBtn.addEventListener('click', toggleDrawer);
    if (closeDrawerBtn) closeDrawerBtn.addEventListener('click', toggleDrawer);
    if (drawerOverlay) drawerOverlay.addEventListener('click', toggleDrawer);
</script>
<script src="{% static 'js/dashboard.js' %}?v=1.1"></script>
{% endblock %}